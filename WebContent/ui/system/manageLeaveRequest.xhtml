<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions"
	template="/common/commonLayout.xhtml">

	<ui:param name="uploadRootPath" value="/image" />

	<ui:define name="title">Employee Leave Management</ui:define>

	<ui:define name="content">

		<!-- Global Messages -->
		<h:form id="globalMessageForm">
			<p:growl id="msgs" escape="false" globalOnly="true" life="5000"
				showDetail="true" />
		</h:form>

		<!-- Leave Request Form -->
		<h:form id="leaveForm" enctype="multipart/form-data">
			<p:panel header="Leave Request Entry" style="margin-bottom:20px">
				<p:panelGrid columns="2" columnClasses="ui-grid-col-6,ui-grid-col-6"
					layout="grid" styleClass="ui-panelgrid-blank ui-fluid">
					<p:panelGrid columns="2">
						<!-- Employee Select -->
						<h:outputText value="" />
						<p:message display="text" for="employeeId" />
						<h:outputLabel for="employeeId" value="Employee:" />
						<p:panelGrid styleClass="ui-panelgrid-blank">
							<div class="ui-g ui-fluid">
								<div class="ui-inputgroup ui-g-12 ui-lg-12">
									<p:commandButton styleClass="green-button" icon="fa fa-search"
										actionListener="#{ManageLeaveRequestActionBean.selectEmployee}"
										id="selectEmployeeDialogLink" process="@this">
										<p:ajax event="dialogReturn"
											listener="#{ManageLeaveRequestActionBean.returnEmployee}"
											update="employeeId" />
									</p:commandButton>

									<p:inputText id="employeeId"
										value="#{ManageLeaveRequestActionBean.leaveRequest.employee == null ? '' : ManageLeaveRequestActionBean.leaveRequest.employee.fullName}"
										readonly="true" />

									<p:commandButton styleClass="red-button" icon="fa fa-times"
										action="#{ManageLeaveRequestActionBean.leaveRequest.setEmployee(null)}"
										process="@this" update="employeeId" />
								</div>
							</div>
						</p:panelGrid>

						<!-- Leave Type -->
						<h:outputText value="" />
						<p:message display="text" for="leaveType" />
						<h:outputLabel for="leaveType" value="Leave Type:"
							styleClass="input-label mandatory" />
						<p:selectOneMenu id="leaveType"
							value="#{ManageLeaveRequestActionBean.leaveRequest.leaveType}"
							required="true" filter="true">
							<f:selectItem itemLabel="-- Select Leave Type --" itemValue="" />
							<f:selectItem itemLabel="Casual Leave" itemValue="CASUAL" />
							<f:selectItem itemLabel="Medical Leave" itemValue="MEDICAL" />
						</p:selectOneMenu>

						<!-- Start Date -->
						<h:outputText value="" />
						<p:message display="text" for="startDate" />
						<h:outputLabel for="startDate" value="Start Date:"
							styleClass="input-label mandatory" />
						<p:calendar id="startDate"
							value="#{ManageLeaveRequestActionBean.leaveRequest.startDate}"
							pattern="dd-MM-yyyy" required="true" showIcon="true" />

						<!-- End Date -->
						<h:outputText value="" />
						<p:message display="text" for="endDate" />
						<h:outputLabel for="endDate" value="End Date:"
							styleClass="input-label mandatory" />
						<p:calendar id="endDate"
							value="#{ManageLeaveRequestActionBean.leaveRequest.endDate}"
							pattern="dd-MM-yyyy" required="true" showIcon="true" />

						<!-- Reason -->
						<h:outputText value="" />
						<p:message display="text" for="reason" />
						<h:outputLabel for="reason" value="Reason:"
							styleClass="input-label mandatory" />
						<p:inputTextarea id="reason"
							value="#{ManageLeaveRequestActionBean.leaveRequest.reason}"
							rows="4" autoResize="true" required="true"
							placeholder="Enter reason for leave..." />

						<!-- Medical Record Upload -->
						<h:outputText value="" />
						<p:message display="text" for="medicalAttachment" />
						<h:outputLabel for="medicalAttachment" value="Medical Record:"
							styleClass="input-label mandatory" />
						<h:panelGrid>
							<p:fileUpload allowTypes="/(\.|\/)(pdf|gif|jpe?g|png)$/"
								fileUploadListener="#{ManageLeaveRequestActionBean.handleProposalAttachment}"
								id="medicalAttachment" mode="advanced" multiple="true"
								sizeLimit="50000000" update="medicalImageGrid" />
							<p:dataGrid columns="4" id="medicalImageGrid" paginator="true"
								rows="8"
								value="#{ManageLeaveRequestActionBean.medicalUploadedFileList}"
								var="image">
								<p:panel>
									<h:outputLink
										onclick="window.open('/efigp/image/#{image}');return false;">
										<pe:documentViewer width="100%" height="250"
											value="#{ManageLeaveRequestActionBean.getMedicalRecordImage(image)}"
											rendered="#{ManageLeaveRequestActionBean.isPdfFile(image)}" />
										<p:graphicImage style="width:120px;height:120px;"
											value="#{ManageLeaveRequestActionBean.getMedicalRecordImage(image)}"
											rendered="#{ManageLeaveRequestActionBean.isImageFile(image)}" />
									</h:outputLink>
									<br />

									<p:commandLink
										action="#{ManageLeaveRequestActionBean.removeMedicalUploadedFile(image)}"
										id="deleteGroupLink" update="medicalImageGrid">
										<p:graphicImage styleClass="delete-icon"
											value="/resources/icons/delete.png" />
									</p:commandLink>
								</p:panel>
							</p:dataGrid>
						</h:panelGrid>


					</p:panelGrid>
				</p:panelGrid>

				<!-- Buttons -->
				<p:commandButton value="Submit" icon="pi pi-check"
					styleClass="ui-button-success p-mr-2 p-px-4 p-py-2"
					action="#{ManageLeaveRequestActionBean.save()}"
					update=":globalMessageForm:msgs :listForm:leaveTable" />
				<p:commandButton value="Reset" type="reset" icon="pi pi-refresh"
					styleClass="ui-button-secondary p-px-4 p-py-2" />
			</p:panel>
		</h:form>

		<!-- Existing Leave Requests Table -->
		<h:form id="listForm">
			<p:panel header="Existing Leave Requests">
				<p:dataTable id="leaveTable" var="leave"
					value="#{ManageLeaveRequestActionBean.leaveRequests}"
					paginator="true" rows="8">


					<p:column headerText="Full Name">
						<h:outputText value="#{leave.employee.fullName}" />
					</p:column>

					<p:column headerText="Leave Type">
						<h:outputText value="#{leave.leaveType}" />
					</p:column>

					<p:column headerText="Start Date">
						<h:outputText value="#{leave.startDate}">
							<f:convertDateTime pattern="dd-MMM-yyyy" />
						</h:outputText>
					</p:column>

					<p:column headerText="End Date">
						<h:outputText value="#{leave.endDate}">
							<f:convertDateTime pattern="dd-MMM-yyyy" />
						</h:outputText>
					</p:column>

					<p:column headerText="Reason">
						<h:outputText value="#{leave.reason}" />
					</p:column>

					<p:column headerText="Medical Record">
						<p:graphicImage
							value="#{ManageLeaveRequestActionBean.firstMedicalRecordImage(leave)}"
							style="width:100px;height:100px;" cache="false" />
					</p:column>

					<p:column headerText="Status">
						<h:outputText value="#{leave.status}" />
					</p:column>

					<p:column headerText="Actions"
						style="width:150px; text-align:center">
						<p:commandButton icon="fa fa-pencil" title="Edit"
							update=":editForm" oncomplete="PF('editDialog').show()">
							<f:setPropertyActionListener value="#{leave}"
								target="#{ManageLeaveRequestActionBean.selectedLeaveRequest}" />
						</p:commandButton>

						<p:commandButton icon="fa fa-trash" title="Delete"
							action="#{ManageLeaveRequestActionBean.delete(leave)}"
							update=":listForm:leaveTable :globalMessageForm:msgs">
							<p:confirm header="Confirmation"
								message="Are you sure you want to delete this leave request?"
								icon="pi pi-exclamation-triangle" />
						</p:commandButton>
					</p:column>
				</p:dataTable>

				<p:confirmDialog global="true">
					<p:commandButton value="Yes" type="button"
						styleClass="ui-confirmdialog-yes ui-button-success"
						icon="pi pi-check" />
					<p:commandButton value="No" type="button"
						styleClass="ui-confirmdialog-no ui-button-danger"
						icon="pi pi-times" />
				</p:confirmDialog>
			</p:panel>
		</h:form>

		<!-- Edit Leave Request Dialog -->
		<h:form id="editForm" enctype="multipart/form-data">
			<p:dialog header="Edit Leave Request" widgetVar="editDialog"
				modal="true" resizable="false" closable="true" appendTo="@(body)">
				<p:panelGrid columns="2" columnClasses="label,value">
					<p:outputLabel for="editLeaveType" value="Leave Type" />
					<p:selectOneMenu id="editLeaveType"
						value="#{ManageLeaveRequestActionBean.selectedLeaveRequest.leaveType}">
						<f:selectItem itemLabel="-- Select Leave Type --" itemValue="" />
						<f:selectItem itemLabel="Casual Leave" itemValue="CASUAL" />
						<f:selectItem itemLabel="Medical Leave" itemValue="MEDICAL" />
					</p:selectOneMenu>

					<p:outputLabel for="editStartDate" value="Start Date" />
					<p:calendar id="editStartDate"
						value="#{ManageLeaveRequestActionBean.selectedLeaveRequest.startDate}"
						pattern="dd-MM-yyyy" showIcon="true" />

					<p:outputLabel for="editEndDate" value="End Date" />
					<p:calendar id="editEndDate"
						value="#{ManageLeaveRequestActionBean.selectedLeaveRequest.endDate}"
						pattern="dd-MM-yyyy" showIcon="true" />

					<p:outputLabel for="editReason" value="Reason" />
					<p:inputTextarea id="editReason"
						value="#{ManageLeaveRequestActionBean.selectedLeaveRequest.reason}"
						rows="4" autoResize="true" />
				</p:panelGrid>

				<p:commandButton value="Update" icon="pi pi-check"
					action="#{ManageLeaveRequestActionBean.update()}"
					update=":listForm:leaveTable :globalMessageForm:msgs"
					oncomplete="PF('editDialog').hide()" />
				<p:commandButton value="Cancel" type="button"
					onclick="PF('editDialog').hide()" icon="pi pi-times" />
			</p:dialog>
		</h:form>

	</ui:define>
</ui:composition>
